name: Test PDF Extraction

on:
  workflow_dispatch:

jobs:
  test_extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pdfplumber

      - name: Create and Run Extraction Script
        run: |
          cat << 'EOF' > test_extraction.py
          import pdfplumber
          import re
          import json
          import os

          def fix_arabic_visual(text):
              if not text: return ""
              # ØªØ¬Ø±Ø¨Ø© Ø£ÙˆÙ„ÙŠØ©: Ø¹ÙƒØ³ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
              return text[::-1]

          def run_test_sample(pdf_path, pages_count=20):
              sample_data = {}
              code_pattern = re.compile(r'(\d{2}\.\d{2})')
              print(f"ğŸ§ ÙØ­Øµ Ø£ÙˆÙ„ {pages_count} ØµÙØ­Ø§Øª Ù…Ù†: {pdf_path}")

              if not os.path.exists(pdf_path):
                  print(f"âŒ Error: {pdf_path} not found!")
                  return

              with pdfplumber.open(pdf_path) as pdf:
                  for i in range(min(pages_count, len(pdf.pages))):
                      page = pdf.pages[i]
                      text = page.extract_text()
                      if not text: continue
                      lines = text.split('\n')
                      current_code = None
                      for line in lines:
                          match = code_pattern.search(line)
                          if match:
                              current_code = match.group(1).replace('.', '')
                              sample_data[current_code] = ""
                          if current_code:
                              sample_data[current_code] += line + " "

              final_sample = {k: fix_arabic_visual(v.strip()) for k, v in sample_data.items()}
              with open('test_sample.json', 'w', encoding='utf-8') as f:
                  json.dump(final_sample, f, ensure_ascii=False, indent=4)
              print(f"âœ… Success! Extracted {len(final_sample)} items.")

          run_test_sample("Ø§Ù„Ø´Ø±ÙˆØ­Ø§Øª.pdf")
          EOF
          python test_extraction.py

      - name: Commit and Push Sample JSON
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add test_sample.json
          git commit -m "Add test sample from PDF [skip ci]" || echo "No changes"
          git push
